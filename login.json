{
    "status": "success",
    "source_code_1": "if($conn->connect_error){\n    echo 'Connection Faild: '.$conn->connect_error;\n    }\nelse{\n    $sql = \"select * from users where email like '%$email%'\";\n    $res = $conn->query($sql);\n    if($row = $res->fetch_assoc()){\n        if($row['password'] == $password && $row['password'] != ''){\n            if($row['type'] == '1'){\n                $sql1 = \"select * from teacher where email like '%$email%'\";\n                $res1 = $conn->query($sql1);\n                $row1 = $res1->fetch_assoc();\n                $_SESSION['first_name'] = $row1['first_name'];\n            }\n            if($row['type'] == '2'){\n                $sql1 = \"select * from assistants where email like '%$email%'\";\n                $res1 = $conn->query($sql1);\n                $row1 = $res1->fetch_assoc();\n                $_SESSION['first_name'] = $row1['first_name'];\n            }\n            if($row['type'] == '3'){\n                \n                $sql1 = \"select * from students where email like '%$email%'\";\n                $res1 = $conn->query($sql1);\n                $row1 = $res1->fetch_assoc();\n                $_SESSION['first_name'] = $row1['first_name'];\n                $_SESSION['section_id'] = $row1['section_id'];\n                $student_id = $row1['id'];\n                if($row1['multi_login']==0){\n                    $device_identifier = $_SERVER['REMOTE_ADDR'] . $_SERVER['HTTP_USER_AGENT'];\n                    $sqllogin = \"SELECT * FROM login_device WHERE student_id =\".$row1['id'];\n                    $reslogin = $conn->query($sqllogin);\n                    if( $reslogin->num_rows == 0){\n                        $querylogin_device=\"INSERT INTO `login_device`(`student_id`, `device`) VALUES (\".$row1['id'].\",'\".$device_identifier.\"')\";\n                        $resultlogin_device = $conn->query($querylogin_device);\n                    }\n                    else{\n                        $rowlogin = $reslogin->fetch_assoc();\n                        if($rowlogin['device'] != $device_identifier){\n                            $multi_login = true;\n                        }\n                    }\n                }\n                \n                // Check if it's the first login of the month\n                $currentMonth = date('m');\n                $query = \"SELECT DATE_FORMAT(MAX(login_time), '%m') as last_login_month FROM monthly_login WHERE student_id =\" . $student_id;\n\n                $result = $conn->query($query);\n                \n                if($result->num_rows > 0){\n                    $row2 = $result->fetch_assoc();\n                    $lastLoginMonth = $row2['last_login_month'];\n                }else{\n                    $lastLoginMonth= 0;\n                }\n                \n                if ($lastLoginMonth == $currentMonth) {\n                    // Not the first login of the month\n                    $query = \"INSERT INTO last_login (student_id, login_time) VALUES ($student_id, NOW())\";\n                    $result = $conn->query($query);\n                } else {\n                    // No previous login found\n                    // First login of the month\n                    $query = \"select * FROM wallet WHERE teacher_id=\".$row['teacher_id'];\n                    $result = $conn->query($query);\n                    $row2 = $result->fetch_assoc();\n                    if($row2['amount'] >= 15){\n                        $wallet_id = $row2['id'];\n                        $oldamount = $row2['amount'];\n                        $newamount = $oldamount-15;\n                        $query = \"UPDATE `wallet` SET `amount`=\".$newamount.\" WHERE id=\".$wallet_id;\n                        $result = $conn->query($query);\n                        $details =  \"خصم  حضور الطالب \".$row1['first_name'];\n                        $query = \"INSERT INTO `transactions`(`wallet_id`, `details`, `amount_after_transaction`, `amount_before_transaction`, `transaction_fee`) VALUES ($wallet_id,'$details',$newamount,$oldamount,15)\";\n                        $result = $conn->query($query);\n                        $query = \"INSERT INTO monthly_login (student_id, login_time,teacher_id) VALUES ($student_id, NOW(),\".$row['teacher_id'].\")\";\n                        $result = $conn->query($query);\n                        $query = \"INSERT INTO last_login (student_id, login_time) VALUES ($student_id, NOW())\";\n                        $result = $conn->query($query);\n                    }\n                    else{\n                        $no_login = true;\n                        \n                    }\n                }\n            }\n            $_SESSION['email'] = $_GET[\"email\"];\n            $_SESSION['password'] = $_GET[\"password\"];\n            $_SESSION['login'] = true;\n            $_SESSION['id'] = $row['id'];\n            $_SESSION['type'] = $row['type'];\n            $_SESSION['teacher_id'] = $row['teacher_id'];\n            $_SESSION['portal_id'] =$row['portal_id'];\n            $_SESSION['lang'] = $row['lang'];\n            $portal_id = $row['portal_id'];\n            $sql1 = \"select * from portals where id like '$portal_id'\";\n            $res1 = $conn->query($sql1);\n            if($row1 = $res1->fetch_assoc()){\n                \n                \n                //header('Location: ');\n                $_SESSION['portal'] = $row1['url'];\n                $_SESSION['portal_name'] = $row1['name'];\n                $_SESSION['logo'] = $row1['logo'];\n                $currentURL = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? \"https\" : \"http\") . \"://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]\";\n                $parsedUrl = parse_url($currentURL);\n                $host = explode('.', $parsedUrl['host']);\n                //$domain = $host[1].'/';\n                if(isset($no_login)){\n                    header('Location: '.$domain.'?q=contact_admin');\n                    session_unset();\n                    // destroy the session\n                    session_destroy();\n                }\n                else if(isset($multi_login)){\n                    header('Location: '.$domain.'?q=multi_login');\n                    session_unset();\n                    // destroy the session\n                    session_destroy();\n                }\n                else{\n                    header('Location: '.$domain);\n                }\n            }\n        }\n        else if ($row['password'] == ''){\n            $_SESSION['email'] = $email;\n            $_SESSION['setpassword'] = true;\n            header('Location: setpassword/');\n        }\n        else\n        {\n            header('Location: '.$domain.'?q=Error_Message');\n            session_unset();\n            // destroy the session\n            session_destroy();\n        }\n    }\n    else\n    {\n        header('Location: '.$domain.'?q=Error_Message');\n        session_unset();\n\n        // destroy the session\n        session_destroy();\n    }\n}"
}
